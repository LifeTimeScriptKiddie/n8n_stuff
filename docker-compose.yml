services:
  postgres:
    image: postgres:15-alpine
    container_name: recon_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-recon_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-recon_hub}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
      - ./migrations:/docker-entrypoint-initdb.d/migrations:ro
    networks:
      - recon-net
    ports:
      - "0.0.0.0:5432:5432"
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-recon_user} -d ${POSTGRES_DB:-recon_hub}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: recon_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - recon-net
    ports:
      - "0.0.0.0:6379:6379"
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: recon_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
    volumes:
      - minio_data:/data
    networks:
      - recon-net
    ports:
      - "0.0.0.0:9000:9000"
      - "0.0.0.0:9001:9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 10s
      retries: 3

  n8n-recon:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: n8n_recon_hub
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    environment:
      #enables command execution
      NODES_EXCLUDE: "[]"
      # Database Configuration
      DB_TYPE: postgresdb
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-recon_hub}
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-recon_user}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: public

      # n8n Configuration
      N8N_HOST: localhost
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      N8N_EDITOR_BASE_URL: http://localhost:5678
      WEBHOOK_URL: http://localhost  
      N8N_PROXY_HOPS: 1
      # Security - Basic Auth
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-true}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE:-false}
      # Encryption
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      # Timezone
      GENERIC_TIMEZONE: ${TIMEZONE:-UTC}
      TZ: ${TIMEZONE:-UTC}

      # Settings
      EXECUTIONS_DATA_SAVE_ON_ERROR: all
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: all
      EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS: true

      # CORS Configuration (allow web interface to call webhooks)
      N8N_CORS_ORIGIN: http://localhost:8080,http://127.0.0.1:8080


      # Environment paths
      SECLISTS_PATH: /opt/SecLists

      # Ollama Configuration
      OLLAMA_HOST: http://ollama:11434

      # Chroma Vector DB Configuration
      CHROMA_HOST: http://chroma:8000
      CHROMA_COLLECTION_PENTEST: pentest_knowledge

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # MinIO Configuration
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin123}
      MINIO_BUCKET_EVIDENCE: raw-evidence
      MINIO_BUCKET_REPORTS: reports

      # Credential Encryption Key (for ephemeral credential encryption)
      CREDENTIAL_ENCRYPTION_KEY: ${CREDENTIAL_ENCRYPTION_KEY:-}

      # Third-Party API Keys
      SHODAN_API_KEY: ${SHODAN_API_KEY}
      CENSYS_API_ID: ${CENSYS_API_ID}
      CENSYS_API_SECRET: ${CENSYS_API_SECRET}
      VIRUSTOTAL_API_KEY: ${VIRUSTOTAL_API_KEY}
      SHODAN_RATE_LIMIT: ${SHODAN_RATE_LIMIT:-1}
      CENSYS_RATE_LIMIT: ${CENSYS_RATE_LIMIT:-0.4}
      VIRUSTOTAL_RATE_LIMIT: ${VIRUSTOTAL_RATE_LIMIT:-4}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./scopes:/home/node/.n8n/scopes:ro
      - recon_workspace:/opt/recon-workspace
      - loot:/opt/loot

    ports:
      - "0.0.0.0:5678:5678"  # n8n admin access

    networks:
      - recon-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      ollama:
        condition: service_started
      chroma:
        condition: service_started

    cap_add:
      - NET_ADMIN
      - NET_RAW

    healthcheck:
      test: ['CMD-SHELL', 'wget --spider -q http://localhost:5678/healthz || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  ollama:
    image: ollama/ollama:latest
    container_name: recon_ollama
    restart: unless-stopped
    environment:
      - OLLAMA_NUM_PARALLEL=3
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - recon-net
    ports:
      - "0.0.0.0:11435:11434"
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:11434/api/tags || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  chroma:
    image: chromadb/chroma:latest
    container_name: recon_chroma
    restart: unless-stopped
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=TRUE
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - recon-net
    ports:
      - "0.0.0.0:8000:8000"
    healthcheck:
      test: ['CMD-SHELL', 'python -c "import urllib.request; urllib.request.urlopen(\"http://localhost:8000\")" || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: n8n_nginx_proxy
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./web-interface:/usr/share/nginx/html:ro
    ports:
      - "80:80"
      - "8080:80"
    networks:
      - recon-net
    depends_on:
      - n8n-recon
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  recon-net:
    driver: bridge
    name: recon_network

volumes:
  postgres_data:
    name: recon_postgres_data
  n8n_data:
    name: recon_n8n_data
  recon_workspace:
    name: recon_workspace
  loot:
    name: recon_loot
  ollama_data:
    name: recon_ollama_data
  redis_data:
    name: recon_redis_data
  minio_data:
    name: recon_minio_data
  chroma_data:
    name: recon_chroma_data
