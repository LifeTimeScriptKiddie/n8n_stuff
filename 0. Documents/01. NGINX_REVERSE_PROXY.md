# Nginx Reverse Proxy Setup
**n8n Reconnaissance Platform - Local Deployment**

---

## Overview

This guide explains the nginx reverse proxy architecture for the n8n reconnaissance platform. The reverse proxy provides a single entry point for both the web interface and n8n webhooks, eliminating the need for external tunnel services like ngrok.

---

## Table of Contents

1. [Architecture](#architecture)
2. [Why Nginx Instead of Ngrok](#why-nginx-instead-of-ngrok)
3. [How It Works](#how-it-works)
4. [Configuration](#configuration)
5. [Access Points](#access-points)
6. [Security](#security)
7. [Troubleshooting](#troubleshooting)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  User Browser (localhost)                                    │
│  http://localhost/                                            │
└───────────────────────┬─────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│  Nginx Reverse Proxy (Port 80)                               │
│  Container: n8n_nginx_proxy                                   │
│                                                                │
│  Routes:                                                       │
│  • /              → Static web interface                      │
│  • /webhook/*     → n8n:5678/webhook/*                        │
│  • /api/*         → n8n:5678/api/*                            │
│  • /health        → nginx health check                        │
│  • /healthz       → n8n:5678/healthz                          │
└───────────────────┬─────────────┬────────────────────────────┘
                    │             │
                    ▼             ▼
         ┌──────────────┐  ┌─────────────────┐
         │ Static Files │  │  n8n (Port 5678) │
         │ web-interface│  │  Container:       │
         │              │  │  n8n_recon_hub    │
         └──────────────┘  └─────────┬─────────┘
                                     │
                                     ▼
                           ┌─────────────────┐
                           │ PostgreSQL       │
                           │ (Port 5432)      │
                           │ Container:       │
                           │ recon_postgres   │
                           └─────────────────┘
```

---

## Why Nginx Instead of Ngrok

### Previous Architecture (with ngrok)
- Required external ngrok service for webhook access
- Exposed localhost to the internet
- Required ngrok account and auth token
- Random URLs on free tier
- Security concerns with public exposure
- Monthly cost for static subdomain ($8/month)

### Current Architecture (with nginx)
- ✅ **No external dependencies** - Everything runs locally
- ✅ **No internet exposure** - Completely internal
- ✅ **Single entry point** - Port 80 for everything
- ✅ **Static configuration** - No changing URLs
- ✅ **No cost** - Free and open source
- ✅ **Better security** - Localhost-only by default
- ✅ **Simpler setup** - No accounts or tokens needed

### Use Case Comparison

| Feature | Ngrok | Nginx |
|---------|-------|-------|
| **Local-only access** | ❌ No | ✅ Yes |
| **Internet webhooks** | ✅ Yes | ❌ No |
| **Setup complexity** | High | Low |
| **Cost** | $0-8/month | $0 |
| **Security** | Requires hardening | Secure by default |
| **URL stability** | Random (free) | Always localhost |
| **Best for** | External webhooks | Local automation |

---

## How It Works

### 1. Request Flow

**Web Interface Access:**
```
Browser: http://localhost/
  ↓
Nginx: Serves /usr/share/nginx/html/index.html
  ↓
Browser displays web interface
```

**Webhook Call from Web Interface:**
```
Browser JavaScript: fetch('/webhook/phase2-active-recon', ...)
  ↓
Nginx: Receives request at /webhook/phase2-active-recon
  ↓
Nginx: Proxies to http://n8n-recon:5678/webhook/phase2-active-recon
  ↓
n8n: Processes webhook and triggers workflow
  ↓
n8n: Returns JSON response
  ↓
Nginx: Forwards response back to browser
```

**n8n Admin Access:**
```
Browser: http://localhost:5678/
  ↓
Direct connection to n8n (bypasses nginx)
  ↓
n8n admin interface
```

### 2. Docker Networking

All services communicate via Docker's internal network (`recon-net`):

- **nginx** can reach **n8n** at `n8n-recon:5678`
- **n8n** can reach **postgres** at `postgres:5432`
- Host can reach **nginx** at `localhost:80`
- Host can reach **n8n** directly at `localhost:5678` (bound to 127.0.0.1 only)

### 3. Port Bindings

| Service | Internal Port | External Port | Binding |
|---------|---------------|---------------|---------|
| **nginx** | 80 | 80 | `0.0.0.0:80` (all interfaces) |
| **n8n** | 5678 | 5678 | `127.0.0.1:5678` (localhost only) |
| **postgres** | 5432 | 5432 | `127.0.0.1:5432` (localhost only) |

---

## Configuration

### nginx.conf

Located at: `/Users/tester/Documents/CodeCollector/n8n/nginx.conf`

**Key sections:**

```nginx
# Upstream definition
upstream n8n_backend {
    server n8n-recon:5678;
}

server {
    listen 80;
    server_name localhost;

    # Static web interface
    location / {
        root /usr/share/nginx/html;
        index index.html;
    }

    # Proxy webhooks to n8n
    location /webhook/ {
        proxy_pass http://n8n_backend/webhook/;
        # Headers for proper proxying
    }

    # Proxy API requests to n8n
    location /api/ {
        proxy_pass http://n8n_backend/api/;
    }
}
```

### docker-compose.yml

**nginx service:**
```yaml
nginx:
  image: nginx:alpine
  container_name: n8n_nginx_proxy
  restart: unless-stopped
  volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf:ro
    - ./web-interface:/usr/share/nginx/html:ro
  ports:
    - "80:80"
  networks:
    - recon-net
  depends_on:
    - n8n-recon
```

**n8n service (updated):**
```yaml
n8n-recon:
  environment:
    WEBHOOK_URL: http://localhost/webhook  # Points to nginx
  ports:
    - "127.0.0.1:5678:5678"  # Localhost-only access
```

### Environment Variables

In `.env`:
```bash
# Webhook URL for n8n
WEBHOOK_URL=http://localhost/webhook
```

This tells n8n to generate production webhook URLs like:
- `http://localhost/webhook/phase2-active-recon`
- `http://localhost/webhook/recon-scan`

---

## Access Points

### For End Users

| Service | URL | Purpose |
|---------|-----|---------|
| **Web Interface** | `http://localhost/` | Submit scan targets |
| **Web Interface** | `http://localhost:8080/` | Alternative direct access (if needed) |

### For Administrators

| Service | URL | Purpose |
|---------|-----|---------|
| **n8n Admin** | `http://localhost:5678/` | Workflow management |
| **PostgreSQL** | `localhost:5432` | Database access |

### For Automation/API

| Endpoint | URL | Method | Purpose |
|----------|-----|--------|---------|
| **Webhook** | `http://localhost/webhook/{path}` | POST | Trigger workflows |
| **n8n API** | `http://localhost/api/v1/*` | Various | n8n API access |
| **Health** | `http://localhost/health` | GET | Nginx health |
| **n8n Health** | `http://localhost/healthz` | GET | n8n health |

---

## Security

### Security Features

1. **Localhost Binding**
   - n8n and PostgreSQL only accessible from host machine
   - `127.0.0.1:5678` and `127.0.0.1:5432`
   - Not exposed to LAN or internet

2. **Network Isolation**
   - All containers on isolated Docker network `recon-net`
   - No direct external access

3. **CORS Headers**
   - Nginx adds CORS headers for web interface
   - Allows same-origin webhook calls

4. **No Public Exposure**
   - Everything runs on localhost
   - No firewall rules needed
   - No domain or SSL certificates needed

### Accessing from Other Machines (Optional)

If you need to access from another machine on your LAN:

**Option 1: SSH Tunnel (Recommended)**
```bash
# From remote machine
ssh -L 8080:localhost:80 user@server-ip
# Then access: http://localhost:8080
```

**Option 2: Change Port Binding (Less Secure)**
```yaml
# In docker-compose.yml
nginx:
  ports:
    - "0.0.0.0:80:80"  # Exposes to LAN
```

**Option 3: VPN (Most Secure)**
- Use Tailscale or WireGuard
- Access via VPN IP address

---

## Troubleshooting

### Issue 1: "Connection Refused" When Accessing Web Interface

**Symptoms:**
- Browser shows "Connection refused" at `http://localhost/`

**Diagnosis:**
```bash
# Check if nginx container is running
docker compose ps nginx

# Check nginx logs
docker logs n8n_nginx_proxy
```

**Solutions:**
1. Verify nginx container is running: `docker compose ps`
2. Restart containers: `docker compose restart nginx`
3. Check for port conflicts: `lsof -i :80` or `netstat -an | grep :80`

---

### Issue 2: Webhooks Return 502 Bad Gateway

**Symptoms:**
- Web interface loads, but form submission fails with 502 error

**Diagnosis:**
```bash
# Check n8n container status
docker compose ps n8n-recon

# Check n8n logs
docker logs n8n_recon_hub

# Check nginx error logs
docker logs n8n_nginx_proxy 2>&1 | grep error
```

**Solutions:**
1. Verify n8n is running and healthy
2. Check `WEBHOOK_URL` in `.env` matches nginx configuration
3. Verify workflow is activated in n8n admin
4. Restart both containers:
   ```bash
   docker compose restart n8n-recon nginx
   ```

---

### Issue 3: CORS Errors in Browser Console

**Symptoms:**
- Browser console shows CORS policy errors
- Fetch requests fail

**Diagnosis:**
```bash
# Check CORS headers in response
curl -I http://localhost/webhook/test
```

**Solutions:**
1. Verify nginx.conf has `Access-Control-Allow-Origin` headers
2. Check web interface is served from same origin (localhost)
3. Restart nginx: `docker compose restart nginx`

---

### Issue 4: Cannot Access n8n Admin at localhost:5678

**Symptoms:**
- `http://localhost:5678` doesn't load

**Diagnosis:**
```bash
# Check port binding
docker compose ps n8n-recon

# Verify n8n is running
docker logs n8n_recon_hub --tail 50
```

**Solutions:**
1. Verify docker-compose.yml has:
   ```yaml
   ports:
     - "127.0.0.1:5678:5678"
   ```
2. Check n8n is healthy:
   ```bash
   curl http://localhost:5678/healthz
   ```
3. Restart n8n: `docker compose restart n8n-recon`

---

### Issue 5: Web Interface Shows But Webhook Calls Fail

**Symptoms:**
- Web interface loads correctly
- Form submission returns errors or no response

**Diagnosis:**
```bash
# Test webhook manually
curl -X POST http://localhost/webhook/phase2-active-recon \
  -H "Content-Type: application/json" \
  -d '{"target": "example.com"}'

# Check if workflow is activated
# Visit http://localhost:5678/ and verify toggle is ON
```

**Solutions:**
1. **Activate workflow in n8n:**
   - Open http://localhost:5678/
   - Navigate to workflow
   - Click toggle switch (make it green/ON)

2. **Verify webhook path matches:**
   - Check workflow webhook node path
   - Compare with `N8N_WEBHOOK_URL` variable in JavaScript

3. **Check n8n logs for errors:**
   ```bash
   docker logs n8n_recon_hub -f
   # Submit form and watch for errors
   ```

---

## Maintenance

### Updating nginx.conf

After modifying `nginx.conf`:

```bash
# Restart nginx to apply changes
docker compose restart nginx

# Verify configuration is valid
docker exec n8n_nginx_proxy nginx -t
```

### Viewing Logs

```bash
# Nginx access logs
docker logs n8n_nginx_proxy

# Nginx error logs
docker logs n8n_nginx_proxy 2>&1 | grep error

# Follow logs in real-time
docker logs -f n8n_nginx_proxy
```

### Health Checks

```bash
# Check all services
docker compose ps

# Test nginx health
curl http://localhost/health

# Test n8n health (via nginx)
curl http://localhost/healthz

# Test n8n health (direct)
curl http://localhost:5678/healthz
```

---

## Comparison: Before vs After

| Aspect | Before (with ngrok) | After (with nginx) |
|--------|---------------------|---------------------|
| **Setup Time** | 15-20 minutes | 5 minutes |
| **External Dependencies** | ngrok account, authtoken | None |
| **Security Concerns** | Public exposure | Localhost only |
| **URL Stability** | Changes on restart (free) | Always localhost |
| **Cost** | $0-8/month | $0 |
| **Complexity** | High | Low |
| **Internet Required** | Yes (for tunneling) | No |
| **Best For** | External webhooks | Local automation |

---

## Future Enhancements

### Adding HTTPS (Optional)

For production deployments, you can add SSL/TLS:

1. **Generate self-signed certificate:**
   ```bash
   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout nginx-selfsigned.key \
     -out nginx-selfsigned.crt
   ```

2. **Update nginx.conf:**
   ```nginx
   server {
       listen 443 ssl;
       ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
       ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
       # ... rest of config
   }
   ```

3. **Update docker-compose.yml:**
   ```yaml
   nginx:
     ports:
       - "443:443"
     volumes:
       - ./ssl:/etc/nginx/ssl:ro
   ```

### Adding Authentication

For multi-user scenarios:

1. **Basic Auth:**
   ```bash
   # Create password file
   htpasswd -c .htpasswd admin
   ```

2. **Update nginx.conf:**
   ```nginx
   location / {
       auth_basic "Restricted Access";
       auth_basic_user_file /etc/nginx/.htpasswd;
       # ... rest of config
   }
   ```

---

## Summary

The nginx reverse proxy provides a simple, secure, and cost-effective solution for local n8n deployment:

- ✅ **Single entry point** on port 80
- ✅ **No external dependencies** or accounts needed
- ✅ **Localhost-only by default** for maximum security
- ✅ **Simple configuration** and maintenance
- ✅ **No cost** and fully open source

For local automation workflows, this architecture is superior to external tunnel services like ngrok.

---

**Questions or issues?** Check the troubleshooting section above or review nginx logs.
