# n8n Recon Hub - Backup & Restore Guide

Complete guide for backing up and restoring all data, users, and n8n workflows.

---

## üéØ What Needs to Be Backed Up

### Critical Data (MUST Backup):

1. **PostgreSQL Database** - Contains:
   - ‚úÖ All n8n users and passwords (hashed)
   - ‚úÖ All n8n workflows
   - ‚úÖ All n8n credentials (encrypted)
   - ‚úÖ All workflow executions
   - ‚úÖ All recon data (scans, vulnerabilities, etc.)
   - ‚úÖ n8n settings and configuration

2. **n8n Encryption Key** - Required to:
   - ‚úÖ Decrypt stored credentials
   - ‚úÖ Access encrypted workflow data
   - ‚ö†Ô∏è  **WITHOUT THIS KEY, ALL CREDENTIALS ARE LOST FOREVER!**

3. **Environment File (.env)** - Contains:
   - ‚úÖ Database passwords
   - ‚úÖ n8n encryption key
   - ‚úÖ Configuration settings

### Important Data (Should Backup):

4. **Docker Volumes** - Contains:
   - n8n data (workflows, settings, binary data)
   - Scan results in `/opt/recon-workspace`
   - Loot/extracted data in `/opt/loot`

---

## üöÄ Quick Backup (Essential Only)

The fastest way to backup everything critical:

```bash
# Run the automated backup script
./backup.sh

# Creates:
# - backups/backup_YYYYMMDD_HHMMSS/
#   ‚îú‚îÄ‚îÄ database.sql
#   ‚îú‚îÄ‚îÄ encryption_key.txt
#   ‚îú‚îÄ‚îÄ .env
#   ‚îî‚îÄ‚îÄ metadata.txt
```

---

## üì¶ What's Included in Each Backup

### 1. Database Backup (database.sql)

**Contains:**
- All users (email, passwords, roles, settings)
- All n8n workflows (JSON definitions)
- All credentials (encrypted with encryption key)
- All workflow executions (history)
- All recon data (subdomain_intel, network_scans, vulnerabilities, etc.)
- All n8n settings

**Size:** Varies (typically 10MB - 1GB depending on usage)

**Format:** PostgreSQL SQL dump (plain text, can be compressed)

---

### 2. Encryption Key (encryption_key.txt)

**Contains:**
- 64-character hex string (e.g., `0b4ac070599abf8fffd42c484f3330a9...`)

**Critical:**
- ‚ö†Ô∏è  This key is required to decrypt all n8n credentials
- ‚ö†Ô∏è  Without it, database restore will succeed but credentials will be unusable
- ‚ö†Ô∏è  Store separately in password manager or encrypted vault

**Size:** 65 bytes

---

### 3. Environment File (.env)

**Contains:**
- PostgreSQL credentials
- n8n encryption key (same as above)
- Configuration settings (timezone, host, etc.)

**Size:** ~1KB

---

## üìã Backup Methods

### Method 1: Automated Backup Script (Recommended)

Use the provided `backup.sh` script:

```bash
# Full backup
./backup.sh

# Backup with custom location
./backup.sh /path/to/backup/dir

# Output:
# ‚úì Database backup completed
# ‚úì Encryption key backed up
# ‚úì Environment file backed up
# ‚úì Metadata recorded
#
# Backup location: backups/backup_20251028_143022/
```

**Includes:**
- Database SQL dump
- Encryption key
- .env file
- Metadata (date, versions, checksums)

---

### Method 2: Manual PostgreSQL Backup

Backup just the database:

```bash
# Backup database to file
docker compose exec -T postgres pg_dump -U recon_user recon_hub > backup_$(date +%Y%m%d).sql

# Verify backup
ls -lh backup_*.sql

# Compress (optional)
gzip backup_20251028.sql
# Creates: backup_20251028.sql.gz
```

**Restore:**
```bash
# Restore database
docker compose exec -T postgres psql -U recon_user -d recon_hub < backup_20251028.sql
```

---

### Method 3: Docker Volume Backup

Backup all Docker volumes:

```bash
# Backup n8n data volume
docker run --rm \
  -v recon_n8n_data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/n8n_data_$(date +%Y%m%d).tar.gz -C /data .

# Backup workspace volume
docker run --rm \
  -v recon_workspace:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/workspace_$(date +%Y%m%d).tar.gz -C /data .

# Backup loot volume
docker run --rm \
  -v recon_loot:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/loot_$(date +%Y%m%d).tar.gz -C /data .
```

**Restore:**
```bash
# Restore n8n data volume
docker run --rm \
  -v recon_n8n_data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar xzf /backup/n8n_data_20251028.tar.gz -C /data
```

---

### Method 4: Encryption Key Only (Critical!)

**Backup encryption key separately:**

```bash
# Extract encryption key from .env
grep N8N_ENCRYPTION_KEY .env > encryption_key_backup.txt

# Or from CREDENTIALS.txt
grep -A 5 "Encryption Key" CREDENTIALS.txt > encryption_key_backup.txt

# Store in password manager
cat encryption_key_backup.txt
```

‚ö†Ô∏è  **Store this in:**
- Password manager (1Password, LastPass, Bitwarden)
- Encrypted USB drive
- Secure cloud storage (encrypted)
- Physical secure location (safe)

---

## üîÑ Restore Procedures

### Full Restore (All Data)

**Prerequisites:**
- Backup files available
- Docker containers running
- Database empty or willing to overwrite

**Steps:**

```bash
# Use the automated restore script (RECOMMENDED)
./restore.sh backups/backup_20251028_150030/

# The script automatically:
# - Checks if PostgreSQL password matches backup
# - Recreates containers if passwords don't match
# - Restores encryption key
# - Restores database
# - Verifies everything works
```

**Manual Restore (Alternative):**

```bash
# 1. Stop n8n (keep database running)
docker compose stop n8n-recon

# 2. Restore encryption key to .env
# Edit .env and set:
N8N_ENCRYPTION_KEY=<your_backed_up_key>

# 3. Check if database password matches
# If your current postgres password differs from backup, you'll need to:
docker compose down
# Then update .env with backup's POSTGRES_PASSWORD
docker compose up -d
# Wait for postgres to be ready

# 4. Restore database
docker compose exec -T postgres psql -U recon_user -d recon_hub < backup_20251028.sql

# 5. Restart n8n
docker compose start n8n-recon

# 6. Verify
# - Open http://localhost:5678
# - Login with restored user
# - Check workflows exist
# - Test credentials work
```

**‚ö†Ô∏è Important: Password Mismatch Issue**

The PostgreSQL container password is set when it's first created. If you:
1. Restore a backup with a different database password, AND
2. The postgres container is already running with a different password

You'll get authentication errors. The `restore.sh` script automatically detects and fixes this by recreating containers with the correct password.

---

### Restore Users Only

If you only need to restore users:

```bash
# Backup current database first!
docker compose exec -T postgres pg_dump -U recon_user recon_hub > current_backup.sql

# Restore only user table
docker compose exec -T postgres psql -U recon_user -d recon_hub -c "TRUNCATE TABLE \"user\" CASCADE;"
docker compose exec -T postgres psql -U recon_user -d recon_hub < backup_users_only.sql
```

---

### Restore Single Workflow

Export/import specific workflow from n8n UI:

1. **Export workflow:**
   - Open workflow in n8n
   - Click "..." menu ‚Üí "Download"
   - Saves as JSON file

2. **Import workflow:**
   - Click "Add workflow" ‚Üí "Import from File"
   - Select JSON file
   - Workflow restored with all settings

---

### Restore After Complete Data Loss

If you lost everything but have backups:

```bash
# 1. Fresh installation
git clone <repo>
cd n8n-recon-hub

# 2. Restore .env file
cp /path/to/backup/.env .env

# 3. Start containers
docker compose up -d

# 4. Wait for PostgreSQL to be ready
docker compose exec postgres pg_isready -U recon_user -d recon_hub

# 5. Restore database
docker compose exec -T postgres psql -U recon_user -d recon_hub < /path/to/backup/database.sql

# 6. Restart n8n
docker compose restart n8n-recon

# 7. Verify everything works
open http://localhost:5678
```

---

## ü§ñ Automated Backup Strategies

### Strategy 1: Daily Cron Job

```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM
0 2 * * * cd /path/to/n8n-recon-hub && ./backup.sh /mnt/backups/daily

# Add weekly backup on Sunday at 3 AM
0 3 * * 0 cd /path/to/n8n-recon-hub && ./backup.sh /mnt/backups/weekly
```

---

### Strategy 2: Backup Script with Retention

The provided `backup.sh` script includes:
- Automatic timestamped backups
- Retention policy (keeps last 30 days)
- Old backup cleanup
- Compression
- Verification

---

### Strategy 3: Remote Backup (rsync)

```bash
# Backup to remote server
./backup.sh

# Sync to remote location
rsync -avz --delete backups/ user@remote-server:/backups/n8n-recon/

# Or use rclone for cloud storage
rclone sync backups/ remote:n8n-backups/
```

---

## üìä Backup Schedule Recommendations

### Recommended Schedule:

| Frequency | What to Backup | Retention |
|-----------|----------------|-----------|
| **Daily** | Database + Encryption Key | 7 days |
| **Weekly** | Full backup (DB + Volumes) | 4 weeks |
| **Monthly** | Full backup + offsite copy | 12 months |
| **Before Major Changes** | Full backup | Keep indefinitely |

### Estimated Sizes:

| Component | Typical Size | With Compression |
|-----------|--------------|------------------|
| Database (new) | 10-50 MB | 2-10 MB |
| Database (6 months) | 500 MB - 2 GB | 100-400 MB |
| n8n data volume | 50-200 MB | 10-50 MB |
| Workspace volume | 100 MB - 10 GB | 20 MB - 2 GB |
| Loot volume | Variable | Variable |

---

## üîê Security Best Practices

### Backup Security:

1. **Encrypt backups:**
   ```bash
   # Encrypt backup with gpg
   gpg --symmetric --cipher-algo AES256 backup_20251028.sql
   # Creates: backup_20251028.sql.gpg

   # Decrypt
   gpg --decrypt backup_20251028.sql.gpg > backup_20251028.sql
   ```

2. **Store encryption key separately:**
   - Never store encryption key with database backup
   - Use password manager
   - Keep offline copy in secure location

3. **Restrict backup file permissions:**
   ```bash
   chmod 600 backup_*.sql
   chmod 600 encryption_key_backup.txt
   chmod 600 .env.backup
   ```

4. **Use encrypted storage:**
   - Encrypt backup drive (LUKS, FileVault, BitLocker)
   - Use encrypted cloud storage
   - Encrypted rsync/rclone

5. **Test restores regularly:**
   - Monthly restore test
   - Verify credentials work after restore
   - Document any issues

---

## üß™ Testing Backups

### Verification Checklist:

```bash
# 1. Test database backup integrity
docker compose exec -T postgres pg_restore --list backup_20251028.sql

# 2. Test restore in isolated environment
docker compose -f docker-compose.test.yml up -d
docker compose -f docker-compose.test.yml exec -T postgres psql -U recon_user -d recon_hub < backup_20251028.sql

# 3. Verify encryption key
grep N8N_ENCRYPTION_KEY .env
# Compare with backed up key

# 4. Check backup file sizes
ls -lh backups/

# 5. Verify backup is not corrupted
md5sum backup_20251028.sql
# Compare with recorded checksum
```

---

## üíæ Backup Storage Options

### Local Storage:
- ‚úÖ Fast access
- ‚úÖ No internet required
- ‚ùå Vulnerable to hardware failure
- ‚ùå Lost if server compromised

### Network Storage (NAS):
- ‚úÖ Centralized
- ‚úÖ Redundant (RAID)
- ‚úÖ Accessible from multiple servers
- ‚ùå Network dependency

### Cloud Storage:
- ‚úÖ Offsite protection
- ‚úÖ Highly redundant
- ‚úÖ Accessible anywhere
- ‚ùå Requires internet
- ‚ùå Ongoing cost
- ‚ö†Ô∏è  Ensure encryption!

**Recommended:** 3-2-1 Backup Strategy
- **3** copies of data
- **2** different storage types (local + cloud)
- **1** offsite backup

---

## üÜò Disaster Recovery Scenarios

### Scenario 1: Accidental User Deletion

```bash
# Restore user table from backup
docker compose exec -T postgres psql -U recon_user -d recon_hub << EOF
BEGIN;
DELETE FROM "user" WHERE email = 'deleted@example.com';
-- Restore from backup instead:
\i /path/to/backup_before_deletion.sql
COMMIT;
EOF
```

---

### Scenario 2: Corrupted Workflow

1. Open n8n UI
2. Go to Settings ‚Üí Import
3. Import workflow from backup JSON
4. Delete corrupted workflow

---

### Scenario 3: Lost Encryption Key

‚ö†Ô∏è  **THIS IS UNRECOVERABLE WITHOUT BACKUP!**

If you lost the encryption key:
- All encrypted credentials are permanently lost
- Workflows will load but credentials won't work
- You'll need to re-enter all credentials manually

**Prevention:**
- Store encryption key in password manager
- Keep offline copy in safe
- Include in every backup

---

### Scenario 4: Complete Server Failure

1. Get new server
2. Install Docker
3. Clone repository
4. Restore `.env` from backup (with encryption key!)
5. Start containers: `docker compose up -d`
6. Restore database from backup
7. Verify all services running

**Recovery Time:** 30-60 minutes

---

## üìù Backup Checklist

### Before Major Changes:

- [ ] Run full backup: `./backup.sh`
- [ ] Verify backup completed successfully
- [ ] Test backup can be read
- [ ] Note backup location
- [ ] Proceed with changes

### Weekly Maintenance:

- [ ] Review backup logs
- [ ] Check backup storage space
- [ ] Verify recent backups exist
- [ ] Test restore process (monthly)
- [ ] Update backup scripts if needed

### Monthly Review:

- [ ] Perform test restore
- [ ] Verify encryption key backup
- [ ] Check offsite backup sync
- [ ] Review retention policy
- [ ] Clean up old backups

---

## üîß Backup Script Usage

```bash
# Basic usage
./backup.sh

# Custom backup location
./backup.sh /mnt/external/backups

# Backup with compression
./backup.sh --compress

# Backup with encryption
./backup.sh --encrypt

# Dry run (show what would be backed up)
./backup.sh --dry-run

# Restore from backup
./restore.sh /path/to/backup/backup_20251028/
```

---

## üìû Support

If you need help with backups:

1. Check backup logs: `cat backups/latest/backup.log`
2. Verify containers running: `docker compose ps`
3. Check database connectivity: `docker compose exec postgres pg_isready`
4. Review this guide's troubleshooting section

---

## ‚ö†Ô∏è Critical Reminders

1. **BACKUP THE ENCRYPTION KEY SEPARATELY!**
   - Store in password manager
   - Keep offline copy
   - Never lose this!

2. **Test your backups regularly**
   - Monthly restore test
   - Verify credentials work

3. **Automate backups**
   - Set up cron jobs
   - Monitor backup success

4. **Use 3-2-1 strategy**
   - 3 copies
   - 2 storage types
   - 1 offsite

5. **Secure your backups**
   - Encrypt backups
   - Restrict permissions
   - Encrypted storage

---

**Remember: A backup is only good if you can restore from it!**

Test your backups regularly! üîê
