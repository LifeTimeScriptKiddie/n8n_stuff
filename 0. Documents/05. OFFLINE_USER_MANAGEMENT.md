# n8n Offline User Management

This guide explains how to manage n8n users directly from the command line without using the web interface.

## Overview

After disabling Basic Auth and enabling n8n's multi-user system, you can manage users offline using the provided bash scripts. These scripts interact directly with the PostgreSQL database and handle password hashing automatically.

## Available Scripts

### 1. Add User (`add-user.sh`)

Creates a new user in n8n.

**Usage:**
```bash
./add-user.sh
```

**Prompts for:**
- Email address
- First name
- Last name
- Password (hidden input)
- Role selection:
  - `global:owner` - Owner (full system access)
  - `global:admin` - Admin (can manage workflows and users)
  - `global:member` - Member (can create/edit own workflows)

**Example:**
```bash
$ ./add-user.sh
================================
n8n Offline User Addition
================================

Email: analyst@example.com
First Name: John
Last Name: Doe
Password: ********

Available roles:
  1) global:owner   - Owner (full system access)
  2) global:admin   - Admin (can manage workflows and users)
  3) global:member  - Member (can create/edit own workflows)

Select role (1-3) [default: 3]: 2

Creating user with:
  Email: analyst@example.com
  Name: John Doe
  Role: global:admin

Confirm? (y/n): y

✅ User created successfully!
```

---

### 2. List Users (`list-users.sh`)

Displays all users in the system.

**Usage:**
```bash
./list-users.sh
```

**Output:**
```bash
================================
n8n Users
================================

         email         |    name     |      role      | disabled | mfa |  created
-----------------------+-------------+----------------+----------+-----+------------
 admin@recon.local     | Admin User  | global:owner   | No       | No  | 2025-10-28
 analyst@example.com   | John Doe    | global:admin   | No       | No  | 2025-10-28
 viewer@example.com    | Jane Smith  | global:member  | No       | No  | 2025-10-28
```

---

### 3. Reset Password (`reset-password.sh`)

Resets a user's password.

**Usage:**
```bash
./reset-password.sh
```

**Prompts for:**
- Email address of the user
- New password (hidden input)

**Example:**
```bash
$ ./reset-password.sh
================================
n8n Password Reset
================================

Email of user: analyst@example.com
New Password: ********

Reset password for analyst@example.com? (y/n): y

✅ Password reset successfully for: analyst@example.com
```

---

### 4. Delete User (`delete-user.sh`)

Permanently deletes a user from the system.

**Usage:**
```bash
./delete-user.sh
```

**Prompts for:**
- Email address of the user to delete
- Confirmation (must type "DELETE")

**Example:**
```bash
$ ./delete-user.sh
================================
n8n User Deletion
================================

Email of user to delete: olduser@example.com

⚠️  WARNING: This will permanently delete the user!
Email: olduser@example.com

Are you sure? (type 'DELETE' to confirm): DELETE

✅ User deleted (if it existed)
```

---

## User Roles Explained

### Global Roles

| Role | Slug | Permissions |
|------|------|-------------|
| **Owner** | `global:owner` | Full system access. Can manage all settings, users, workflows, and credentials. |
| **Admin** | `global:admin` | Can manage workflows, credentials, and users. Cannot modify system settings. |
| **Member** | `global:member` | Can create and edit their own workflows. Limited access to shared resources. |

### Project-Level Roles

These are assigned within specific projects:
- `project:admin` - Full control of project settings and members
- `project:personalOwner` - Owner of personal project
- `project:editor` - Create, edit, and delete workflows
- `project:viewer` - Read-only access

---

## Important Notes

### Security Considerations

1. **Password Hashing**: All scripts use bcrypt with salt rounds of 10 (same as n8n)
2. **Secure Input**: Passwords are hidden during input using `-sp` flag
3. **Database Access**: Scripts use the existing database credentials from `.env`
4. **No Plain Text**: Passwords are never stored in plain text

### Prerequisites

- Docker and Docker Compose must be running
- The `n8n-recon` and `postgres` containers must be up
- You must have access to the `.env` file with database credentials

### Troubleshooting

**"User with this email already exists!"**
- The email address is already registered. Use `list-users.sh` to see all users.

**"ERROR: User not found"** (during password reset)
- The email address doesn't exist. Check spelling or use `list-users.sh`.

**"Connection refused"**
- Ensure containers are running: `docker compose ps`
- Start containers: `docker compose up -d`

**"Command not found"**
- Ensure scripts are executable: `chmod +x *.sh`
- Run from the correct directory

---

## Advanced: Direct Database Access

If you need to perform custom queries:

```bash
# Access PostgreSQL
docker compose exec postgres psql -U recon_user -d recon_hub

# View user table structure
\d user

# List all users
SELECT email, "firstName", "lastName", "roleSlug" FROM "user";

# Exit
\q
```

---

## Workflow Integration

You can also manage users via n8n workflows using **Postgres** nodes:

### Example: Create User Workflow Node

```sql
-- Check if user exists
SELECT id FROM "user" WHERE email = '{{ $json.email }}';

-- Insert user (password must be pre-hashed)
INSERT INTO "user" (email, "firstName", "lastName", password, "roleSlug")
VALUES ($1, $2, $3, $4, $5)
RETURNING id, email;
```

**Note**: Password hashing in workflows requires a **Code** node:

```javascript
const bcrypt = require('bcrypt');
const password = $input.first().json.password;
const hashedPassword = await bcrypt.hash(password, 10);
return { hashedPassword };
```

---

## Best Practices

1. **Regular Audits**: Run `list-users.sh` periodically to review active users
2. **Strong Passwords**: Enforce strong passwords (12+ characters, mixed case, numbers, symbols)
3. **Least Privilege**: Assign the minimum role necessary (prefer `member` over `admin`)
4. **Remove Inactive Users**: Delete users who no longer need access
5. **Backup First**: Always backup before bulk user operations

---

## Quick Reference

```bash
# Add a new user
./add-user.sh

# List all users
./list-users.sh

# Reset someone's password
./reset-password.sh

# Delete a user
./delete-user.sh

# Check container status
docker compose ps

# Access web UI (after creating first user)
open http://localhost:5678
```

---

## Support

For issues or questions:
- Check container logs: `docker compose logs -f n8n-recon`
- Review database: `docker compose exec postgres psql -U recon_user -d recon_hub`
- n8n Docs: https://docs.n8n.io

---

**Remember**: These scripts provide full user management capabilities without needing the web interface. Perfect for automation, CI/CD pipelines, or server environments without a browser.
